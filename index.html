<!DOCTYPE html>
<html>
<body >
<style type="text/css">
.button {
    background-color: #4CAF50;
    border: none;
    color: white;
    padding: 15px 32px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-size: 16px;
    margin: 4px 2px;
    cursor: pointer;
}
/* The container */
.container {
    display: block;
    position: relative;
    padding-left: 55px;
    margin-bottom: 50px;
    cursor: pointer;
    font-size: 22px;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}

.error-message
{
  
}
/* Hide the browser's default radio button */
.container input {
    position: absolute;
    opacity: 0;
    cursor: pointer;
}

/* Create a custom radio button */
.checkmark {
    position: absolute;
    top: 0;
    left: 0;
    height: 50px;
    width: 50px;
    background-color: #eee;
    border-radius: 50%;
}

/* On mouse-over, add a grey background color */
.container:hover input ~ .checkmark {
    background-color: #ccc;
}
.column {
    float: left;
    width: 50%;
}

/* Clear floats after the columns */
.row:after {
    content: "";
    display: table;
    clear: both;
}
/* When the radio button is checked, add a blue background */
.container input:checked ~ .checkmark {
    background-color: #2196F3;
}

/* Create the indicator (the dot/circle - hidden when not checked) */
.checkmark:after {
    content: "";
    position: absolute;
    display: none;
}

/* Show the indicator (dot/circle) when checked */
.container input:checked ~ .checkmark:after {
    display: block;
}

/* Style the indicator (dot/circle) */
.container .checkmark:after {
 	top: 13px;
	left: 13px;
	width: 25px;
	height: 25px;
	border-radius: 50%;
	background: white;
}

</style>
<div class="row">

  <div class="column">
  <h1>Choose issue type and Press Log button</h1>
  <p>Made <span></span> by @annerajb</p>


   <label class="container">
   Red steering wheel
    <input type="radio" name="type" value="ap-red-wheel" > 
    	<span class="checkmark"></span>
    </label>

   <label class="container">
    Auto Lane Change - Car Cancelled
    <input type="radio" name="type" value="auto-lane-change-car-cancel">
    <span class="checkmark"></span>
    </label>
    <label class="container">
    Auto Lane Change - Manual Override
    <input type="radio" name="type" value="auto-lane-change-manual-override">
    <span class="checkmark"></span>
    </label>
    <label class="container">
    Autopilot Disengaged - Lanes
    <input type="radio" name="type" value="ap-disengagement-car-lines">
    <span class="checkmark"></span>
    </label>
    <label class="container">
    User Disengaged - Lanes
    <input type="radio" name="type" value="ap-disengagement-user-lines">
    <span class="checkmark"></span>
    </label>

    <label class="container">
    Navigate on Autopilot - Route
    <input type="radio" name="type" value="noa-route">
    <span class="checkmark"></span>
    </label>
     <label class="container">
    Navigate on Autopilot - Faster lane suggestion
    <input type="radio" name="type" value="noa-lane">
    <span class="checkmark"></span>
    </label>
    <label class="container">
      Shadow braking
      <input type="radio" name="type" value="shadow-braking">
      <span class="checkmark"></span>
    </label>
<label class="container">
       Other
      <input type="radio" name="type" value="other" checked>
      <span class="checkmark"></span>
    </label>
    <label class="container">
  <button id="driveBtn" class="button" onclick="driveButtonPressed()">Start Drive</button>
    <button class="button" onclick="getLocation()">Log event/issue</button>
    </label>
  </div>

  <div class="column">
  <p class="h2 error-message" id="error_message">
  
  </p>
      <ul id="demo"></ul>
  </div>
<div>
<script>
function initLogEntry()
{
return {Timestamp:null, 
Event:null,
Coords:null};
}
var driveEntries = document.getElementById("demo");
var driveButton = document.getElementById("driveBtn");
var error_text = document.getElementById("error_message");
var start_timestamp = new Date();
var dbName = "tesla-autopilot-log";
var currentDriveEntries = [];
var driveInProgress = false;
var queueLogEntry = initLogEntry();

function startDrive()
{
    start_timestamp = new Date();
    clearCurrentDriveLog();
    
    displayLogEntry("Started drive:"+start_timestamp.toLocaleString());
    logPersistentEvent("started",start_timestamp,null);
    
    driveInProgress = true;
    writeErrorMessage('');
    driveButton.innerHTML = "End Drive";
}
function endDrive()
{

  //Copy / Save this log entry separate
  //Save to
  
  var end_timestamp = new Date;
  
  displayLogEntry("Ended drive:"+end_timestamp.toLocaleString());
  logPersistentEvent("ended",end_timestamp,null);
  
  saveCurrentDrivePermanently();
  
  clearCurrentDriveLog();
  
  driveInProgress = false;
  driveButton.innerHTML = "Start Drive";
}
function saveCurrentDrivePermanently()
{
//load past Drives
	var pastDrivesStr = localStorage.getItem('pastDrivesList');
	if(!pastDrivesStr)
  {
  	pastDrivesStr = JSON.stringify([]);
  }
  pastDrives = JSON.parse(pastDrivesStr);
  pastDrives.push(currentDriveEntries);
  //save past drives
  localStorage.setItem('pastDrivesList', JSON.stringify(pastDrives));
}
function clearCurrentDriveLog()
{
currentDriveEntries = [];
	localStorage.removeItem('currentDriveEntries');
  //remove visual list of log entries for this drive
  while (driveEntries.firstChild) 
  {
      driveEntries.removeChild(driveEntries.firstChild);
  }
}
function logPersistentEvent(event, time,coordinates)
{
  
  var logItem = {Timestamp:time, Event:event,Coords:coordinates};
  //add to memory object
  currentDriveEntries.push(logItem);
  //save to DB
  localStorage.setItem('currentDriveEntries', JSON.stringify(currentDriveEntries));
}

function writeErrorMessage(message)
{
	error_text.innerHTML = message;
}
function geo_error(err)
{
    writeErrorMessage(`ERROR(${err.code}): ${err.message}`);
    displayLogEntry(generateLogEntryString());
    //update persistent database
    logLastEventToPersistent();
}
function driveButtonPressed()
{
	if(!driveInProgress)
  {
		startDrive();
  }else
  {
    endDrive(); 
	}
  
}
function getLocation() 
{
	//in case we forgot to start the drive
	if(!driveInProgress)
  {
		startDrive();
  }
  if (navigator.geolocation)
  {
  	var selected_type = document.querySelector('input[name="type"]:checked').value;
    
    queueLogEntry.Event = selected_type; 
    queueLogEntry.Timestamp = new Date;
    //get gps coords
    navigator.geolocation.getCurrentPosition(showPosition,geo_error);

  } else 
  { 
    writeErrorMessage("Geolocation is not supported by this browser.");
  }

}
function generateLogEntryString()
{
    var content = '';
    if(queueLogEntry.Coords)
    {
      content += "Latitude: " + queueLogEntry.Coords.latitude + 
        "<br>Longitude: " + queueLogEntry.Coords.longitude;
    } else
    {
      content += "No Location<br>";
    }
    content += "<br> Local Time: " + queueLogEntry.Timestamp.toLocaleString() +
      "<br> Event Type: " + queueLogEntry.Event;
  return content;
 
}
function displayLogEntry(content)
{
 		var pnode = document.createElement("p");
    pnode.innerHTML = content;
    var textnode = document.createElement("li");
    textnode.appendChild(pnode);
    driveEntries.insertBefore(textnode,driveEntries.childNodes[0]);
}
function logLastEventToPersistent()
{
		logPersistentEvent(queueLogEntry.Event,queueLogEntry.Timestamp, queueLogEntry.Coords);
}
function showPosition(position) 
{

 	queueLogEntry.Coords = position.coords;
  updateLastLogEntry();
  //update persistent database
  logLastEventToPersistent();
}
</script>

</body>
</html>
